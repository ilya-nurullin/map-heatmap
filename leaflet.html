<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Тепловая карта</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="./webgl-heatmap.js"></script>
     <script src="./leaflet-webgl-heatmap.min.js"></script>
    <script src="./leaflet-heat.js"></script>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #settingsLabel {
            position: fixed;
            right: 0;
            top: 0;
            background: rgba(255, 255, 255, 0.7);;
            display: inline-block;
            padding: 2px;
            color: #0078A8;;
            z-index: 9999999999999;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="settingsLabel">Настройки</div>

<script>
  let map = L.map('map')
      .setView([
        56.8519,
        60.6122
      ], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  let resetHeatMap = () => null;
  let heatLayer = null;

  let dataPoints = [];
  let cityCenterCoords = {
      'ekat': {lat: 56.8519, lng: 60.6122},
      'perm': {lat: 58.01, lng: 56.25},
      'nizh': {lat: 56.32867, lng: 44},
  };

// (Math.tanh(-0.146545736131038 * Math.tanh(57.8391127429404 * (0.548993331515251 * X1 - 32.1434018618834) + 20.9983885528493 * (0.655215970404418 * X2 - 36.313155313229) + 2.8417818552084) - 0.185714385899375 * Math.tanh(3.80060029053366 * (0.548993331515251 * X1 - 32.1434018618834) - 9.58522275102171 * (0.655215970404418 * X2 - 36.313155313229) + 4.65779175733936) + 0.264835397021346 * Math.tanh(297.499853526285 * (0.548993331515251 * X1 - 32.1434018618834) - 155.323757346319 * (0.655215970404418 * X2 - 36.313155313229) + 2.19922943677836) - 0.337840331592217) + 1.0746887966805) / 2.76625173E-07;


  window.addEventListener("message", receiveMessage, false);

  function updateHeatMap(params) {
    let [JsFormula, headMapType, headMapRadius, longitudeFrom, longitudeTo, longitudeStep, latitudeFrom, latitudeTo, latitudeStep, cityName] = params;

    map.panTo(cityCenterCoords[cityName]);

    resetHeatMap();

    eval("window.f = (x1, x2) => "+JsFormula);

    countDataPoints(longitudeFrom, longitudeTo, longitudeStep, latitudeFrom, latitudeTo, latitudeStep);

    if (headMapType === 1)
    {
      heatLayer = L.heatLayer(dataPoints, {
        radius: headMapRadius,
        blur: 0
      }).addTo(map);
    }
    else {
      heatLayer = new L.webGLHeatmap({
          size: headMapRadius,
          opacity: 0.9
      });
      heatLayer.setData(dataPoints);
      map.addLayer(heatLayer);
    }

    resetHeatMap = () => map.removeLayer(heatLayer);
  }

  function countDataPoints(longitudeFrom, longitudeTo, longitudeStep, latitudeFrom, latitudeTo, latitudeStep) {
    dataPoints = [];

    let max = 0;
    let min = Number.MAX_SAFE_INTEGER;
    for (let lat = latitudeFrom; lat <= latitudeTo; lat += latitudeStep) {
      for (let lon = longitudeFrom; lon <= longitudeTo; lon += longitudeStep) {
        let _f = f(lat, lon);

        dataPoints.push([
          lat,
          lon,
          _f
        ]);

        if (_f > max)
          max = _f;
        if (_f < min)
          min = _f;
      }
    }

    let s = max - min;

    dataPoints = dataPoints.map((e) => [
      e[0],
      e[1],
      (e[2] - min) / s
    ]);
  }

  function receiveMessage(event) {
    console.log(event);
    let eName = event.data.event;

    if (eName === "updateHeatMap")
      updateHeatMap(event.data.params);
  }

  document.getElementById("settingsLabel").addEventListener('click', function () {
    window.open("./settings.html");
  });
</script>
</body>
</html>